---
title: CloudManager Provision Dialogs
layout: post
---

# Opt-in to provisioning.
To tell Manageiq that you want to support provisioning you will need to add the following to your CloudManager.rb file.

At the top of the file should be a number of require_nested entries. Add the two lines to the list.
```ruby
  require_nested :Provision
  require_nested :ProvisionWorkflow
```

Replace the variable [ProviderNamespace] with the namespace specific to your plugin.
```ruby
  LABEL_MAPPING_ENTITIES = {
    "Vm"    => "ManageIQ::Providers::[ProviderNamespace]::CloudManager::Vm",
    "Image" => "ManageIQ::Providers::[ProviderNamespace]::CloudManager::Template"
  }.freeze

  supports :provisioning
```

# Defining image templates.
The first step in provisioning is to select a base image. Two files will need to be present. Both files reside within the `cloud_manager` directory.

The first is fairly straight forward create a file `vm_or_template_shared.rb` and put the following contents.

```
module ManageIQ::Providers::IbmCloud::VPC::CloudManager::VmOrTemplateShared
  extend ActiveSupport::Concern
end
```

The second is a `template.rb` file. The `provider_object` method needs to be modified to retrieve a list of vm image templates.

```ruby
class ManageIQ::Providers::[ProviderNamespace]::CloudManager::Template < ManageIQ::Providers::CloudManager::Template
  include_concern 'ManageIQ::Providers::[ProviderNamespace]::CloudManager::VmOrTemplateShared'

  supports :provisioning do
    if ext_management_system
      unsupported_reason_add(:provisioning, ext_management_system.unsupported_reason(:provisioning)) unless ext_management_system.supports_provisioning?
    else
      unsupported_reason_add(:provisioning, _('not connected to ems'))
    end
  end

	def provider_object(connection = nil)
  end
end
```

# Setting up the provision dialogs.
The provision dialogs are controlled by a yaml file. In the provider repo they are stored under the `content/miq_dialogs` folder. It follows a specific pattern and the fields within are not arbitrary. See the next section for details.

To tell manageiq what file to use for the dialog, create a provision_workflow.rb file within the cloud_manager folder of your plugin. Within that file create a class within your CloudManager namespace named `ProvisionWorkflow` and subclass `:MiqProvisionCloudWorkflow`. Use the abbreviated namespace syntax as the nested syntax will hang UI creation. i.e. `class ManageIQ::Providers::IbmCloud::VPC::CloudManager::ProvisionWorkflow < ::MiqProvisionCloudWorkflow`

WIthin the class add a class method named `self.default_dialog_file` that returns the name of the yaml template file, minus the yaml extension.

```ruby
  def self.default_dialog_file
    'miq_provision_vpc_dialogs'
  end
```

# Defining the yaml template contents.
How the yaml file is processed for display is controlled by the haml files in the [manageiq-classic-ui](https://github.com/ManageIQ/manageiq-ui-classic) repo. The container definition is within the [_prov_dialog.html.haml](https://github.com/ManageIQ/manageiq-ui-classic/blob/master/app/views/shared/views/_prov_dialog.html.haml). From there depending on which container is being processed other files will be included. The most common is in [_prov_dialog_fieldset](https://github.com/ManageIQ/manageiq-ui-classic/blob/master/app/views/miq_request/_prov_dialog_fieldset.html.haml). The field definitions are from [_prov_field.html.haml](https://github.com/ManageIQ/manageiq-ui-classic/blob/master/app/views/miq_request/_prov_field.html.haml). The volumes container is defined in [_prov_dialog_volume_fieldset.html.haml](https://github.com/ManageIQ/manageiq-ui-classic/blob/master/app/views/miq_request/_prov_dialog_volume_fieldset.html.haml). Use the [JSON schema](https://jaredm-ibm.github.io/miq_plugin_dev/schemas/cloud_manager_provision.json) in this repo to assist in creating the YAML file.


## Volume container
Volume fields are different from all others. They can only be text fields or checkboxess. They are also defined programtically in the `volume_dialog_keys` method of the ProvisionWorkflow class. In  the example below three fields are available to customize in the yaml template file. This method and a yaml definition are required for the field to show in the UI.
```ruby
  def volume_dialog_keys
    %i[name size profile]
  end
```
